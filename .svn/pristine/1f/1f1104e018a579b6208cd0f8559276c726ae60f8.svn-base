import React, { useEffect, useState } from 'react';
import * as dateFns from "date-fns";
import styles from './ParkingEventList.module.css'
import { getEventsList } from './api/apiService';
import ParkingEventDetail from './ParkingEventDetail';

export default function ParkingInfo({ eventListUpdate, parkingCameras }) {
	const [eventList, setEventList] = useState([]);
	const [activeEvent, setActiveEvent] = useState([]);

	const displayEventOccur = async (eventDetail) => {
		const activeEventArr = activeEvent;
		if (!activeEventArr.some((item) => item === eventDetail.idx)) {
			activeEventArr.push(eventDetail.idx)
		}
		setActiveEvent(activeEventArr)
		setTimeout(() => {
			const activeEventArr = activeEvent;
			setActiveEvent(activeEventArr.filter((item) => item !== eventDetail.idx))
		}, 1000 * 60);
	}

	const getEvents = async () => {

		const today = dateFns.format(dateFns.sub(new Date(), { days: 1 }), "yyyyMMdd");
		const startDate = today;
		const endDate = dateFns.format(new Date(), "yyyyMMdd");
		const endTime = dateFns.format(new Date(), "HHmmss");
		const endDateTime = endDate + 'T' + endTime;

		const res = await getEventsList('parkingcontrol', 'noLimit', startDate, endDateTime);
		const parkingEvent = [];
		if (res && res.eventList && res.eventList.length > 0) {
			res.eventList.map((evt) => {
				parkingEvent.push(evt);
			})
		}
		await displayEventOccur(parkingEvent[parkingEvent.length - 1]);
		await setEventList(parkingEvent);
	}

	useEffect(() => {
		getEvents();
		const eventListSubscription = getEvents();
		return () => {
			if (eventListSubscription && typeof eventListSubscription.cancel === 'function') {
				eventListSubscription.cancel();
			}
		};
	}, [eventListUpdate]);



	return (
		<>
			<div className={styles.menu_eventList}>
				<div>
					<div className={styles.eventList_header}>
						<h5 className={styles.header}>주차 이벤트 리스트</h5>
					</div>
				</div>
				<div className={styles.parking_event} >
					{eventList && eventList.length > 0 ?
						eventList.map((event, index) => {
							return (
								<React.Fragment key={index}>
									<ParkingEventDetail
										event={event}
										active={activeEvent.find(item => (item === event.idx))}
										parkingCameras={parkingCameras}
									/>
								</React.Fragment>
							)
						})
						:
						<span className={styles.unAck_eventList_empty}>미확인 이벤트가 없습니다.</span>
					}
				</div>
			</div>
		</>
	)
}